{% extends "base.html" %}

{% block title %}Novo Brief - EazyBrief{% endblock %}

{% block page_title %}Criar Novo Brief{% endblock %}

{% block extra_css %}
<style>
    .input-section { 
        display: block; 
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .input-section h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #4B5563;
        display: flex;
        align-items: center;
    }
    .input-section h3 i {
        margin-right: 0.5rem;
        color: #6366F1;
    }
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .preview-container {
        margin-top: 1rem;
        padding: 1rem;
        background: #F9FAFB;
        border-radius: 0.5rem;
    }
    .preview-container.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Biblioteca Marked para renderizar markdown no preview -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
console.log('Script do new_brief carregado com sucesso.');

// Variáveis globais para armazenar os dados
let currentImageData = '';
let currentAudioData = null;
let mediaRecorder = null;
let audioChunks = [];

// Funções de upload e preview
function handleImageUpload(input) {
    const file = input.files[0];
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const imagePreviewName = document.getElementById('imagePreviewName');

    if (file && imagePreview && imagePreviewImg && imagePreviewName) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageData = e.target.result;
            imagePreviewImg.src = currentImageData;
            imagePreview.classList.remove('hidden');
            imagePreviewName.textContent = file.name;
        };
        reader.readAsDataURL(file);
    }
}

function removeImage() {
    const imageFile = document.getElementById('imageFile');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const imagePreviewName = document.getElementById('imagePreviewName');

    if (imageFile && imagePreview && imagePreviewImg && imagePreviewName) {
        imageFile.value = '';
        imagePreviewImg.src = '';
        imagePreview.classList.add('hidden');
        imagePreviewName.textContent = '';
        currentImageData = '';
    }
}

function handleAudioUpload(input) {
    const file = input.files[0];
    const audioPreview = document.getElementById('audioPreview');

    if (file && audioPreview) {
        const audioElement = audioPreview.querySelector('audio');
        if (audioElement) {
            currentAudioData = file;
            audioElement.src = URL.createObjectURL(file);
            audioPreview.classList.remove('hidden');
        }
    }
}

function removeAudio() {
    const audioFile = document.getElementById('audioFile');
    const audioPreview = document.getElementById('audioPreview');

    if (audioFile && audioPreview) {
        audioFile.value = '';
        const audioElement = audioPreview.querySelector('audio');
        if (audioElement) {
            audioElement.src = '';
            audioPreview.classList.add('hidden');
            currentAudioData = null;
        }
    }
}

// Função para gravação de áudio
async function startAudioRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        // Parar gravação
        mediaRecorder.stop();
        recordButton.classList.remove('bg-red-600');
        recordButton.classList.add('bg-indigo-600');
        recordButtonText.textContent = 'Gravar Áudio';
        audioStatus.textContent = 'Processando áudio...';
    } else {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (e) => {
                audioChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/m4a' });
                currentAudioData = audioBlob;
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioPreview = document.getElementById('audioPreview');
                const audioElement = audioPreview.querySelector('audio');
                if (audioElement) {
                    audioElement.src = audioUrl;
                    audioPreview.classList.remove('hidden');
                }
                audioStatus.textContent = 'Áudio gravado com sucesso!';
            };
            
            mediaRecorder.start();
            recordButton.classList.remove('bg-indigo-600');
            recordButton.classList.add('bg-red-600');
            recordButtonText.textContent = 'Parar Gravação';
            audioStatus.textContent = 'Gravando...';
        } catch (error) {
            console.error('Erro ao acessar o microfone:', error);
            audioStatus.textContent = 'Erro ao acessar o microfone';
        }
    }
}

// Funções de campos extras
let extraFieldId = 0;

function addExtraField() {
    extraFieldId++;
    const container = document.createElement('div');
    container.className = 'flex space-x-2 items-center fade-in';
    container.id = `extra-field-${extraFieldId}`;
    container.innerHTML = `
        <input type="text" placeholder="Nome do campo" 
               class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        <input type="text" placeholder="Valor" 
               class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        <button type="button" class="text-red-600 hover:text-red-700">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.querySelector('button').addEventListener('click', () => {
        container.remove();
    });
    
    document.getElementById('extra-fields').appendChild(container);
}

function getExtras() {
    const extras = [];
    document.querySelectorAll('#extra-fields > div').forEach(field => {
        const inputs = field.querySelectorAll('input');
        const name = inputs[0].value;
        const value = inputs[1].value;
        if (name && value) {
            extras.push({ name, value });
        }
    });
    return extras;
}

// Função para enviar o briefing
async function generateBrief() {
    const text = document.getElementById('brief-text').value;
    const briefType = document.getElementById('brief-type').value;
    const template = document.getElementById('brief-template').value;
    const extras = getExtras();

    // Validar se pelo menos um formato foi fornecido
    if (!text && !currentAudioData && !currentImageData) {
        showError('Por favor, forneça pelo menos um formato (texto, áudio ou imagem)');
        return;
    }

    // Validar campos obrigatórios
    if (!briefType || !template) {
        showError('Por favor, selecione o tipo e o template do briefing');
        return;
    }

    showLoading();

    try {
        const audioData = currentAudioData ? await blobToBase64(currentAudioData) : '';
        
        const response = await fetch('/api/generate-brief', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text,
                type: briefType,
                template,
                extras,
                image: currentImageData,
                audio: audioData
            })
        });

        const data = await response.json();

        if (response.ok) {
            showResult(data.result);
        } else {
            showError(data.error || 'Erro ao gerar briefing');
        }
    } catch (error) {
        showError('Erro ao comunicar com o servidor');
        console.error('Erro:', error);
    } finally {
        hideLoading();
    }
}

// Função auxiliar para converter Blob para Base64
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Funções de UI
function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50';
    loadingDiv.innerHTML = `
        <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Gerando briefing...</p>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.querySelector('.fixed.inset-0');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

function showResult(result) {
    const resultSection = document.getElementById('result-section');
    const briefResult = document.getElementById('brief-result');
    const briefForm = document.getElementById('brief-form');

    if (resultSection && briefResult && briefForm) {
        briefResult.innerHTML = marked.parse(result);
        resultSection.classList.remove('hidden');
        briefForm.style.display = 'none';
        resultSection.scrollIntoView({ behavior: 'smooth' });
    }
}

function editBrief() {
    // Volta ao formulário preenchido para edição
    const resultSection = document.getElementById('result-section');
    const briefForm = document.getElementById('brief-form');
    if (resultSection && briefForm) {
        resultSection.classList.add('hidden');
        briefForm.style.display = '';
        briefForm.scrollIntoView({ behavior: 'smooth' });
    }
}

function saveBrief() {
    // Mostra mensagem de sucesso ao salvar (pode ser expandido para salvar no backend)
    showError('Briefing salvo com sucesso! (Funcionalidade de persistência pode ser implementada)');
}

function cancelBrief() {
    // Limpa o resultado e volta ao formulário
    const resultSection = document.getElementById('result-section');
    const briefForm = document.getElementById('brief-form');
    const briefResult = document.getElementById('brief-result');
    if (resultSection && briefForm && briefResult) {
        resultSection.classList.add('hidden');
        briefForm.style.display = '';
        briefResult.innerHTML = '';
        briefForm.scrollIntoView({ behavior: 'smooth' });
    }
}

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
    addExtraField();
    
    // Configurar botão de gravação
    const recordButton = document.getElementById('recordButton');
    const recordButtonText = document.getElementById('recordButtonText');
    if (recordButton && recordButtonText) {
        recordButton.addEventListener('click', startAudioRecording);
    }
});
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <form id="brief-form" class="space-y-6">
        <!-- Seção de Texto -->
        <div class="input-section">
            <h3><i class="fas fa-file-alt"></i>Texto</h3>
            <textarea id="brief-text" 
                      class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                      placeholder="Digite ou cole o texto do briefing aqui..."></textarea>
        </div>

        <!-- Seção de Áudio -->
        <div class="input-section">
            <h3><i class="fas fa-microphone"></i>Áudio</h3>
            <div class="flex space-x-4">
                <button type="button" id="recordButton" 
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                    <i class="fas fa-microphone mr-2"></i>
                    <span id="recordButtonText">Gravar Áudio</span>
                </button>
                <input type="file" id="audioFile" accept="audio/*" class="hidden" onchange="handleAudioUpload(this)">
                <button type="button" onclick="document.getElementById('audioFile').click()"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                    <i class="fas fa-upload mr-2"></i>
                    Enviar Arquivo
                </button>
            </div>
            <div id="audioStatus" class="text-sm text-gray-600 mt-2"></div>
            <div id="audioPreview" class="preview-container hidden">
                <audio controls class="w-full"></audio>
                <button type="button" onclick="removeAudio()" class="text-red-600 hover:text-red-700 mt-2">
                    <i class="fas fa-times mr-1"></i>Remover Áudio
                </button>
            </div>
        </div>

        <!-- Seção de Imagem -->
        <div class="input-section">
            <h3><i class="fas fa-image"></i>Imagem</h3>
            <div class="flex space-x-4">
                <input type="file" id="imageFile" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                <button type="button" onclick="document.getElementById('imageFile').click()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                    <i class="fas fa-upload mr-2"></i>
                    Escolher Imagem
                </button>
            </div>
            <div id="imagePreview" class="preview-container hidden">
                <img id="imagePreviewImg" class="max-h-48 mx-auto rounded-lg" src="" alt="Preview">
                <p id="imagePreviewName" class="text-sm text-gray-600 mt-2 text-center"></p>
                <button type="button" onclick="removeImage()" class="text-red-600 hover:text-red-700 mt-2">
                    <i class="fas fa-times mr-1"></i>Remover Imagem
                </button>
            </div>
        </div>

        <!-- Seção de Configurações -->
        <div class="input-section">
            <h3><i class="fas fa-cog"></i>Configurações</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="brief-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Briefing</label>
                    <select id="brief-type" 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecione o tipo</option>
                        <option value="social-media">Social Media</option>
                        <option value="marketing">Marketing</option>
                        <option value="content">Conteúdo</option>
                        <option value="design">Design</option>
                    </select>
                </div>
                <div>
                    <label for="brief-template" class="block text-sm font-medium text-gray-700 mb-1">Template</label>
                    <select id="brief-template" 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecione o template</option>
                        <option value="standard">Padrão</option>
                        <option value="detailed">Detalhado</option>
                        <option value="creative">Criativo</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Seção de Campos Extras -->
        <div class="input-section">
            <h3><i class="fas fa-plus-circle"></i>Campos Extras</h3>
            <div id="extra-fields" class="space-y-3"></div>
            <button type="button" onclick="addExtraField()" 
                    class="mt-3 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Adicionar Campo Extra
            </button>
        </div>

        <!-- Botão de Geração -->
        <div class="flex justify-center">
            <button type="button" onclick="generateBrief()" 
                    class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center text-lg font-semibold">
                <i class="fas fa-magic mr-2"></i>
                Gerar Briefing
            </button>
        </div>
    </form>

    <!-- Seção de Resultado -->
    <div id="result-section" class="hidden mt-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Briefing Gerado</h3>
                <div class="space-x-2">
                    <button onclick="editBrief()" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-edit mr-1"></i>Editar
                    </button>
                    <button onclick="saveBrief()" class="text-green-600 hover:text-green-800">
                        <i class="fas fa-save mr-1"></i>Salvar
                    </button>
                    <button onclick="cancelBrief()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                </div>
            </div>
            <div id="brief-result" class="prose max-w-none"></div>
        </div>
    </div>
</div>
{% endblock %}